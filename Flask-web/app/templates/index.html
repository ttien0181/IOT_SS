{% extends "base.html" %}
{% block title %}Realtime Dashboard{% endblock %}
{% block content %}

  <style>
    /* Custom styles for realtime dashboard */
    .form-select-custom {
      min-width: 120px;
    }
    #boxes_container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      padding: 1rem 0;
    }

    /* Override .box styles for cards */
    .box {
      border: none; /* Bootstrap card handles border */
      padding: 0; /* Bootstrap card handles padding */
      margin: 0; /* Bootstrap grid handles margin */
    }
  </style>

  <h1 class="mb-4">IoT Realtime Dashboard</h1>

  <div class="card p-4 mb-4 shadow-sm">
    <form id="topic_form" class="row g-3 align-items-end">
      <div class="col-md-auto">
        <label for="building" class="form-label">Building:</label>
        <select id="building" class="form-select form-select-custom">
          <option value="A1">A1</option>
        </select>
      </div>

      <div class="col-md-auto">
        <label for="floor" class="form-label">Floor:</label>
        <select id="floor" class="form-select form-select-custom">
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>

      <div class="col-md-auto">
        <label for="room" class="form-label">Room:</label>
        <select id="room" class="form-select form-select-custom">
          <option value="101">101</option>
          <option value="102">102</option>
        </select>
      </div>

      <div class="col-md-auto">
        <label for="data_type" class="form-label">Data Type:</label>
        <select id="data_type" class="form-select form-select-custom">
          <option value="spo2">SpO2</option>
          <option value="heart_rate">Heartrate</option>
          <option value="motion">Motion</option>
        </select>
      </div>

      <div class="col-md-auto">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-plus me-2"></i> Add Sensor
        </button>
      </div>
    </form>
  </div>

   <!-- div contains all box  -->
  <div id="boxes_container"></div>

<script>
  const socket = io();
  let subscriptions = []; // save list of subscribed topics
  
  function removeBox(boxId){
    // Xóa box khỏi giao diện
    const box = document.getElementById(boxId);
    if (box) {
      box.remove();
    }

    // Xóa box khỏi danh sách subscriptions
    subscriptions = subscriptions.filter(sub => sub.boxId !== boxId);

    // Gửi yêu cầu unsubscribe tới server (nếu cần, hiện tại server chưa xử lý)
    // socket.emit("unsubscribe_topic", { topic });  
  }

  // gán sự kiện cho button "submit"
  document.getElementById("topic_form").addEventListener("submit", function (e) {
    e.preventDefault();

    const building = document.getElementById("building").value;
    const floor = document.getElementById("floor").value;
    const room = document.getElementById("room").value;
    const dataType = document.getElementById("data_type").value;

    // make box Id
    const topic = `${building}/${floor}/${room}/${dataType}`;
    const boxId = topic.split('/').join('_'); // Thay đổi / thành _ để làm ID hợp lệ

    // if this box already exists, skip it
    if(document.getElementById(boxId)){
      alert("This sensor data stream is already displayed!");
      return;
    }

    // send subscribe message to server
    socket.emit("subscribe_topic", {
      building,
      floor,
      room,
      data_type: dataType
    });

    subscriptions.push({boxId, topic}); // add to subcription list

    // Tạo box mới
    const container = document.getElementById("boxes_container");
    const box = document.createElement("div");
    box.className = "box card text-center p-3 shadow-sm"; // Thêm class Bootstrap card
    box.id = boxId;
    
    box.innerHTML = `
      <button class="close-btn" onclick="removeBox('${boxId}')">&times;</button>
      <p class="data_label card-title mb-2">${dataType.charAt(0).toUpperCase() + dataType.slice(1)} <small class="text-muted">(${building}-${floor}-${room})</small></p>
      <div class="value_display display-4 fw-bold text-success">--</div>
    `;
    container.appendChild(box);
  });

  socket.on("sensor_update", (data) => { 
    console.log(`gửi ${data.topic}`);
    subscriptions.forEach(sub => {
      // So khớp topic đầy đủ
      if (data.topic === sub.topic) {
        const box = document.getElementById(sub.boxId);
        if (box) {
          const value = data.value;
          const unit = data.unit || "";
          
          box.querySelector(".value_display").innerText = `${value} ${unit}`;
        }
      }
    });
  });

</script>

{% endblock %}