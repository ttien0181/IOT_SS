<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}IoT Dashboard{% endblock %}</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  
  <!-- Font Awesome (cho icon mũi tên nếu muốn thay thế ▼) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <!-- Thư viện Socket.io -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <!-- File CSS tùy chỉnh của bạn (đặt sau Bootstrap để ghi đè) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

  <!-- Sidebar cố định -->
  <div id="sidebar" class="sidebar fixed">
    <h2 class="sidebar-title">IoT Smart Home</h2>
    <nav class="nav flex-column">
      <!-- Trang Realtime -->
      <a class="nav-link {% if request.endpoint == 'main.index' %}active{% endif %}" href="{{ url_for('main.index') }}">
        <i class="fas fa-tachometer-alt me-2"></i> Realtime
      </a>

      <!-- ========== Tree Menu bắt đầu ========== -->
      <!-- Nút cha lớn nhất (ví dụ: Bachmai) -->
      <button class="dropdown-btn">
        <i class="fas fa-building me-2"></i> Bach Mai
      </button>
      <!-- Cây con: Building -->
      <div class="dropdown-container">
        <!-- Building A1 -->
        <button class="dropdown-btn">
          <i class="fas fa-hotel me-2"></i> Building A1
        </button>
        <div class="dropdown-container">
          <!-- Floor 1 -->
          <button class="dropdown-btn">
            <i class="fas fa-layer-group me-2"></i> Floor 1
          </button>
          <div class="dropdown-container">
            <a class="nav-link {% if request.endpoint == 'main.dashboard' and request.view_args.get('room') == '101' %}active{% endif %}" 
               href="{{ url_for('main.dashboard',building='A1', floor='1', room='101') }}">
               <i class="fas fa-door-open me-2"></i> Room 101
            </a>
            <a class="nav-link {% if request.endpoint == 'main.dashboard' and request.view_args.get('room') == '102' %}active{% endif %}" 
               href="{{ url_for('main.dashboard',building='A1', floor='1', room='102') }}">
               <i class="fas fa-door-open me-2"></i> Room 102
            </a>
          </div>

          <!-- Floor 2 -->
          <button class="dropdown-btn">
            <i class="fas fa-layer-group me-2"></i> Floor 2
          </button>
          <div class="dropdown-container">
            <a class="nav-link {% if request.endpoint == 'main.dashboard' and request.view_args.get('room') == '201' %}active{% endif %}" 
               href="{{ url_for('main.dashboard',building='A1', floor='2', room='201') }}">
               <i class="fas fa-door-open me-2"></i> Room 201
            </a>
            <a class="nav-link {% if request.endpoint == 'main.dashboard' and request.view_args.get('room') == '202' %}active{% endif %}" 
               href="{{ url_for('main.dashboard',building='A1', floor='2', room='202') }}">
               <i class="fas fa-door-open me-2"></i> Room 202
            </a>
          </div>
        </div>    
      </div>
      <!-- ========== Tree Menu kết thúc ========== -->
       
      <!-- Trang Profile -->
      <a class="nav-link {% if request.endpoint == 'main.profile' %}active{% endif %}" href="{{ url_for('main.profile') }}">
        <i class="fas fa-user-circle me-2"></i> Profile
      </a>

      <!-- Trang Logout -->
      <a class="nav-link text-danger {% if request.endpoint == 'auth.logout' %}active{% endif %}" href="{{ url_for('auth.logout') }}">
        <i class="fas fa-sign-out-alt me-2"></i> Logout
      </a>
    </nav>
  </div>
  <!-- Kết thúc sidebar -->

  <!-- Nội dung trang -->
  <div id="main-content-fixed">
    <div class="container-fluid">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ 'success' if category == 'message' else 'danger' }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </div>
  </div>
  
  <!-- Bootstrap JS Bundle (popper included) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <!-- Script JavaScript để xử lý menu dạng cây với LocalStorage -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Hàm lưu trạng thái menu vào LocalStorage
      function saveMenuState() {
        const openMenus = [];
        const openDropdowns = document.querySelectorAll('.dropdown-btn.open');
        
        openDropdowns.forEach(btn => {
          const menuId = btn.textContent.trim().replace(/\s+/g, '_');
          openMenus.push(menuId);
        });
        localStorage.setItem('sidebarMenuState', JSON.stringify(openMenus));
      }
      
      // Hàm khôi phục trạng thái menu từ LocalStorage
      function restoreMenuState() {
        const savedMenus = localStorage.getItem('sidebarMenuState');
        if (!savedMenus) {
          return;
        }
        
        try {
          const openMenus = JSON.parse(savedMenus);
          openMenus.forEach(menuId => {
            const buttons = document.querySelectorAll('.dropdown-btn');
            buttons.forEach(btn => {
              const btnId = btn.textContent.trim().replace(/\s+/g, '_');
              if (btnId === menuId) {
                btn.classList.add('open');
                const dropdownContent = btn.nextElementSibling;
                if (dropdownContent && dropdownContent.classList.contains('dropdown-container')) {
                  dropdownContent.style.display = 'block';
                }
              }
            });
          });
        } catch(e) {
          console.error('Lỗi khi khôi phục trạng thái menu:', e);
          localStorage.removeItem('sidebarMenuState');
        }
      }
      
      // BƯỚC 1: Khôi phục trạng thái menu khi trang load
      restoreMenuState();
      
      // BƯỚC 2: Xử lý click dropdown với lưu trạng thái
      var dropdowns = document.getElementsByClassName("dropdown-btn");
      for (var i = 0; i < dropdowns.length; i++) {
        dropdowns[i].addEventListener("click", function() {
          var dropdownContent = this.nextElementSibling;

          if (dropdownContent.style.display === "block") {
            dropdownContent.style.display = "none";
            this.classList.remove("open");
          } else {
            dropdownContent.style.display = "block";
            this.classList.add("open");
          }
          saveMenuState();
        });
      }
      
      // BƯỚC 3: Xóa trạng thái khi đăng xuất
      const logoutLinks = document.querySelectorAll('[href*="logout"]');
      logoutLinks.forEach(link => {
        link.addEventListener('click', function() {
          localStorage.removeItem('sidebarMenuState');
        });
      });
    });
  </script>
</body>
</html>